name: Smartail CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout Latest Code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      # Deploy & Build on Server
      - name: SSH Deploy & Build on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_KEY }}
          env:
            DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
            DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
          script: |
            echo "📦 Pulling latest code..."
            cd /home/${{ secrets.VM_USER }}/smartail-assigment
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/DevenderNarra/smartail-assigment.git .
            fi

            echo "🧹 Removing old containers and images..."
            docker rm -f cricket-frontend || true
            docker rm -f cricket-backend || true
            docker images --filter=reference="${DOCKER_USER}/smartail-frontend*" -q | xargs -r docker rmi -f || true
            docker images --filter=reference="${DOCKER_USER}/smartail-backend*" -q | xargs -r docker rmi -f || true
            docker images -f "dangling=true" -q | xargs -r docker rmi -f

            echo "🔐 Docker login..."
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

            echo "🏗️ Building Docker images..."
            docker build --no-cache -t $DOCKER_USER/smartail-frontend:latest ./frontend
            docker build --no-cache -t $DOCKER_USER/smartail-backend:latest ./backend

            echo "📤 Pushing Docker images..."
            docker push $DOCKER_USER/smartail-frontend:latest
            docker push $DOCKER_USER/smartail-backend:latest

            echo "🚀 Deploying containers..."
            docker-compose up -d --force-recreate --remove-orphans

            echo "🔐 Docker logout..."
            docker logout || true
